<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal Data Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Base Styles --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal.active { display: flex; }
        .panel { display: none; position: absolute; right: 0; top: 100%; width: 200px; background: white; border: 1px solid #ddd; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 500; border-radius: 0.5rem; }
        .panel.active { display: block; }
        .z-high { z-index: 1100 !important; }
        body { overflow-x: hidden; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* --- Hierarchical Panel Styles --- */
        :root {
            --primary: #3b82f6; /* Tailwind blue-500 */
            --primary-dark: #2563eb; /* Tailwind blue-600 */
            --bg: #f8fafc; /* Tailwind slate-50 */
            --white: #ffffff;
            --text: #1e293b; /* Tailwind slate-800 */
            --border: #cbd5e1; /* Tailwind slate-300 */
            --radius: 0.75rem; /* 12px */
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Dropdown Menus - FIXED HIERARCHY dengan auto-flip */
        .h-dropdown-content {
            position: fixed; /* Changed from absolute to fixed */
            background: white;
            min-width: 180px;
            max-width: 300px;
            box-shadow: var(--shadow);
            border-radius: 10px;
            display: none;
            z-index: 9999; /* Increased z-index */
            border: 1px solid var(--border);
            overflow: hidden;
        }
        .h-dropdown-content.active { display: block; }
        .h-drop-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .h-drop-item:hover { background: #f8f9fa; }

        /* Cards (Level 1) */
        .h-card {
            background: var(--white); padding: 1rem; border-radius: var(--radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 0.75rem; cursor: pointer;
            transition: all 0.2s ease; border: 1px solid var(--border);
        }
        .h-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }
        .h-card-id { font-size: 0.7rem; color: #64748b; font-family: monospace; }
        .h-card-title { font-weight: 600; font-size: 1.1rem; margin-top: 0.25rem; color: var(--text); }

        /* Fullscreen Panel */
        .h-panel-fs {
            position: fixed; inset: 0; background: var(--bg); display: none;
            flex-direction: column; z-index: 800;
        }
        .h-panel-fs.active { display: flex; }
        .h-panel-header { 
            background: white; padding: 0.75rem 1rem; display: flex; align-items: center; 
            border-bottom: 1px solid var(--border); gap: 0.625rem; position: sticky; top: 0;
            z-index: 850; /* Increased z-index for header */
        }
        .h-panel-title { 
            flex: 1; font-weight: 600; text-align: center; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            color: var(--text);
        }
        .h-panel-body { 
            flex: 1; overflow-y: auto; padding: 1rem; 
            max-height: calc(100vh - 64px);
        }

        /* Head Items (Level 2) - FIXED CONTAINER OVERFLOW */
        .h-head-item { 
            background: white; border-radius: var(--radius); border: 1px solid var(--border); 
            margin-bottom: 1rem; overflow: visible; /* Changed from hidden to visible */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative;
        }
        .h-head-header { 
            padding: 0.625rem 0.9375rem; background: #f8fafc; 
            border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;
            position: relative; /* Added for dropdown positioning */
            z-index: 5; /* Base z-index for header */
        }
        .h-head-content { padding: 0.9375rem; font-size: 1rem; }
        .h-head-img { 
            width: 100%; max-height: 400px; object-fit: contain; 
            background: #f1f5f9; border-radius: 0.5rem; display: block; margin: 0 auto;
        }

        /* Sub Items (Level 3 - Embeds) */
        .h-sub-container { padding: 0 0.9375rem 0.9375rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .h-sub-item {
            background: #f1f5f9; padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 0.85rem;
            border-left: 3px solid var(--primary); position: relative;
        }
        .h-sub-img { 
            width: 80px; height: 80px; object-fit: cover; border-radius: 0.375rem; 
            margin-top: 0.3125rem; border: 1px solid #ddd; display: block;
        }

        /* Detail Rows */
        .h-detail-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .h-detail-label { color: #64748b; font-weight: 500; }
        
        /* Search Input */
        .h-search-input { 
            flex: 1; padding: 0.75rem; border-radius: var(--radius); 
            border: 1px solid var(--border); outline: none; font-size: 0.875rem;
        }
        .h-search-input:focus { 
            border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Buttons */
        .h-btn { 
            border: none; border-radius: 0.5rem; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            background: white; border: 1px solid var(--border); transition: all 0.2s;
            font-size: 0.875rem;
        }
        .h-btn:hover { background: #f8fafc; }
        .h-btn-icon { width: 2.75rem; height: 2.75rem; font-size: 1.2rem; }
        .h-btn-primary { 
            background: var(--primary); color: white; border: none;
        }
        .h-btn-primary:hover { 
            background: var(--primary-dark); 
        }
        
        /* Modal Specific */
        .modal-hierarchical .modal-box {
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Badge untuk type */
        .type-badge {
            font-size: 0.7rem; padding: 0.125rem 0.5rem; border-radius: 1rem;
            background: #dbeafe; color: var(--primary); font-weight: 600;
        }

        /* Radio Button Styling */
        .radio-option {
            display: flex; align-items: center; padding: 0.75rem; cursor: pointer;
            border-radius: 0.5rem; margin-bottom: 0.25rem;
        }
        .radio-option:hover { background: #f8fafc; }
        .radio-option input[type="radio"] { margin-right: 0.75rem; }

        /* CSS untuk wrapper teks agar tidak keluar viewport */
        .h-sub-text-wrapper {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            max-width: 100%;
        }

        /* Style untuk link */
        .h-link {
            color: #3b82f6; /* biru */
            text-decoration: underline;
            cursor: pointer;
            display: inline-block;
            max-width: 100%;
            word-break: break-all;
        }

        .h-link:hover {
            color: #1d4ed8; /* biru lebih gelap */
        }

        /* Style untuk tombol ellipsis pada sub-item */
        .h-sub-ellipsis {
            position: absolute;
            top: 4px;
            right: 8px;
            color: #64748b;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
            background: rgba(255,255,255,0.9);
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            z-index: 100; /* Increased z-index for ellipsis button */
        }

        .h-sub-ellipsis:hover {
            background: rgba(255,255,255,1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Dropdown untuk sub-item dengan auto-flip */
        .h-sub-dropdown {
            position: fixed;
            background: white;
            min-width: 150px;
            box-shadow: var(--shadow);
            border-radius: 8px;
            display: none;
            z-index: 9998; /* High z-index but below main dropdowns */
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .h-sub-dropdown.active {
            display: block;
        }

        /* Style untuk panel header ellipsis */
        .h-panel-header .h-btn {
            position: relative;
            z-index: 860; /* Higher than header */
        }

        /* Panel ellipsis dropdown harus di atas segalanya */
        #panelMenu.h-dropdown-content {
            z-index: 10000 !important;
        }

        /* Style untuk GitHub list yang lebih informatif */
        .github-source-item {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
        }

        .github-source-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .github-source-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
        }

        .github-source-details {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }

        .github-source-url {
            font-family: monospace;
            font-size: 0.7rem;
            color: #3b82f6;
            background: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            word-break: break-all;
            margin-top: 0.25rem;
        }

        .github-url-item {
            margin-bottom: 0.125rem;
        }

        /* Style untuk LocalStorage list */
        .localstorage-source-item {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
        }

        .localstorage-source-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .localstorage-source-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
        }

        .localstorage-source-key {
            font-family: monospace;
            font-size: 0.8rem;
            color: #64748b;
            background: #f8fafc;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            word-break: break-all;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- MAIN HEADER -->
    <header class="bg-blue-600 text-white p-4 flex justify-between items-center sticky top-0 z-50 shadow-md">
        <h1 class="font-bold truncate">Universal Data Manager</h1>
        <div class="relative">
            <button onclick="toggleSettingsPanel(event)" class="text-2xl p-1 focus:outline-none hover:bg-blue-700 rounded">‚öôÔ∏è</button>
            <div id="sources-panel" class="panel p-2 text-gray-800 mt-2">
                <p class="font-bold border-b pb-1 mb-2 text-sm">Pengaturan</p>
                <button onclick="openModal('settings-sources-modal')" class="w-full text-left p-2 hover:bg-gray-100 rounded text-sm">Sumber Data</button>
            </div>
        </div>
    </header>

    <!-- NAVIGATION TABS -->
    <nav class="bg-white border-b flex items-center overflow-x-auto custom-scrollbar no-wrap px-2 space-x-2" id="tab-nav">
        <!-- Tabs injected here -->
        <button onclick="openModal('add-tab-modal')" class="p-2 text-blue-600 font-bold text-xl hover:bg-blue-50 rounded">+</button>
    </nav>

    <!-- TAB CONTENTS AREA -->
    <main id="tab-container" class="p-4 mb-20">
        <!-- Tab contents injected here -->
    </main>

    <!-- ===== MODAL: SETTINGS SOURCES ===== -->
    <div id="settings-sources-modal" class="modal z-high">
        <div class="bg-white w-full max-w-2xl rounded-lg p-5 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="font-bold">Sumber Data</h2>
                <button onclick="closeModal('settings-sources-modal')" class="text-xl hover:bg-gray-100 w-8 h-8 rounded-full flex items-center justify-center">&times;</button>
            </div>
            
            <div class="flex border-b mb-4">
                <button onclick="switchSourceTab('github')" id="tab-btn-github" class="flex-1 py-2 border-b-2 border-blue-600 font-medium">Github</button>
                <button onclick="switchSourceTab('localstorage')" id="tab-btn-local" class="flex-1 py-2 font-medium">LocalStorage</button>
            </div>

            <!-- GitHub Source List -->
            <div id="source-tab-github">
                <button onclick="openAddGithubModal()" class="w-full bg-blue-600 text-white py-2 rounded mb-4 text-sm hover:bg-blue-700">Tambah Sumber Baru</button>
                <div id="github-list" class="space-y-2"></div>
            </div>

            <!-- LocalStorage Source List -->
            <div id="source-tab-local" class="hidden">
                <button onclick="openModal('add-localstorage-source-modal')" class="w-full bg-blue-600 text-white py-2 rounded mb-4 text-sm hover:bg-blue-700">Tambah Sumber Baru</button>
                <div id="localstorage-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- ===== MODAL: ADD GITHUB SOURCE ===== -->
    <div id="add-github-source-modal" class="modal z-high">
        <div class="bg-white w-full max-w-md rounded-lg p-5">
            <h2 class="font-bold mb-4">Tambah Sumber GitHub</h2>
            <div class="space-y-3">
                <input type="text" id="gh-pat" placeholder="PAT (Personal Access Token)" class="w-full border p-2 rounded text-sm">
                <input type="text" id="gh-owner" placeholder="Pemilik (owner)" class="w-full border p-2 rounded text-sm">
                <input type="text" id="gh-repo" placeholder="Nama Repo" class="w-full border p-2 rounded text-sm">
                <input type="text" id="gh-branch" placeholder="Branch (default: main)" class="w-full border p-2 rounded text-sm">
                <input type="text" id="gh-path" placeholder="Path (contoh: path/to/data)" class="w-full border p-2 rounded text-sm">
                <input type="text" id="gh-file" placeholder="Nama File (contoh: db.json)" class="w-full border p-2 rounded text-sm">
            </div>
            <div class="flex justify-end mt-4 space-x-2">
                <button onclick="closeModal('add-github-source-modal')" class="px-4 py-2 text-sm hover:bg-gray-100 rounded">Batal</button>
                <button onclick="saveGithubSource()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- ===== MODAL: ADD LOCALSTORAGE SOURCE ===== -->
    <div id="add-localstorage-source-modal" class="modal z-high">
        <div class="bg-white w-full max-w-sm rounded-lg p-5">
            <h2 class="font-bold mb-4">Tambah KEY LocalStorage</h2>
            <input type="text" id="ls-key" placeholder="Nama Kunci Penyimpanan" class="w-full border p-2 rounded text-sm">
            <div class="flex justify-end mt-4 space-x-2">
                <button onclick="closeModal('add-localstorage-source-modal')" class="px-4 py-2 text-sm hover:bg-gray-100 rounded">Batal</button>
                <button onclick="saveLocalSource()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- ===== MODAL: ADD TAB ===== -->
    <div id="add-tab-modal" class="modal z-high">
        <div class="bg-white w-full max-w-sm rounded-lg p-5">
            <h2 class="font-bold mb-4">Tambah Tab Baru</h2>
            <input type="text" id="new-tab-name" placeholder="Nama Tab" class="w-full border p-2 rounded mb-4">
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal('add-tab-modal')" class="px-4 py-2 text-sm hover:bg-gray-100 rounded">Batal</button>
                <button onclick="createNewTab()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Tambah</button>
            </div>
        </div>
    </div>

    <!-- ===== MODAL: CURRENT DATA ===== -->
    <div id="current-data-modal" class="modal z-high">
        <div class="bg-white w-full max-w-md rounded-lg p-5">
            <h2 class="font-bold mb-2">Pilih Sumber Konten</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold block mb-1">Tipe Sumber</label>
                    <select id="cur-source-type" onchange="updateSourceSelectors('cur')" class="w-full border p-2 rounded">
                        <option value="github">Github</option>
                        <option value="localstorage">LocalStorage</option>
                        <option value="device">File Perangkat</option>
                    </select>
                </div>
                <div id="cur-list-container">
                    <label class="text-xs font-bold block mb-1">Daftar Sumber</label>
                    <div class="flex space-x-2">
                        <select id="cur-source-list" class="flex-1 border p-2 rounded"></select>
                        <button onclick="triggerAddFromSelector('cur')" class="bg-green-600 text-white px-3 rounded hover:bg-green-700">+</button>
                    </div>
                </div>
                <div id="cur-device-container" class="hidden text-center py-4 border-2 border-dashed rounded">
                    <button onclick="document.getElementById('file-input').click()" class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600">+ Unggah File</button>
                    <input type="file" id="file-input" class="hidden" accept=".json" onchange="handleFileUpload(event)">
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-2">
                <button onclick="closeModal('current-data-modal')" class="px-4 py-2 text-sm border rounded hover:bg-gray-100">Tutup</button>
                <button onclick="loadDataFromSource()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Ambil & Muat</button>
            </div>
        </div>
    </div>

    <!-- ===== MODAL: EXPORT DATA ===== -->
    <div id="export-data-modal" class="modal z-high">
        <div class="bg-white w-full max-w-md rounded-lg p-5">
            <h2 class="font-bold mb-2">Ekspor Data</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold block mb-1">Tipe Tujuan</label>
                    <select id="exp-source-type" onchange="updateSourceSelectors('exp')" class="w-full border p-2 rounded">
                        <option value="github">Github</option>
                        <option value="localstorage">LocalStorage</option>
                        <option value="device">File Perangkat</option>
                    </select>
                </div>
                <div id="exp-list-container">
                    <label class="text-xs font-bold block mb-1">Daftar Tujuan</label>
                    <div class="flex space-x-2">
                        <select id="exp-source-list" class="flex-1 border p-2 rounded"></select>
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-2">
                <button onclick="closeModal('export-data-modal')" class="px-4 py-2 text-sm border rounded hover:bg-gray-100">Tutup</button>
                <button onclick="exportDataToSource()" class="px-4 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700">Ekspor Sekarang</button>
            </div>
        </div>
    </div>

    <!-- ===== HIERARCHICAL PANEL MODALS ===== -->
    <!-- Modal: Tambah Konten Baru -->
    <div id="modalAddRoot" class="modal modal-hierarchical z-high">
        <div class="bg-white w-full max-w-sm rounded-lg p-5">
            <h3 class="font-bold mb-4">Tambah Konten Baru</h3>
            <input type="text" id="rootTitleInput" class="w-full border p-2 rounded mb-4" placeholder="Judul Konten">
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal('modalAddRoot')" class="px-4 py-2 text-sm hover:bg-gray-100 rounded">Batal</button>
                <button onclick="hierarchicalAddRoot()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal: Edit Judul Konten -->
    <div id="modalEditTitle" class="modal modal-hierarchical z-high">
        <div class="bg-white w-full max-w-sm rounded-lg p-5">
            <h3 class="font-bold mb-4">Edit Judul Konten</h3>
            <input type="text" id="editTitleInput" class="w-full border p-2 rounded mb-4" placeholder="Judul Baru">
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal('modalEditTitle')" class="px-4 py-2 text-sm hover:bg-gray-100 rounded">Batal</button>
                <button onclick="hierarchicalSaveTitle()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal: Urutkan Konten -->
    <div id="modalSortMain" class="modal modal-hierarchical z-high">
        <div class="bg-white w-full max-w-sm rounded-lg p-5">
            <h3 class="font-bold mb-4">Urutkan Konten</h3>
            <div class="space-y-1">
                <label class="radio-option">
                    <input type="radio" name="sortMode" value="updated" onchange="hierarchicalSetSort('updated')">
                    <span>Berdasarkan Waktu Diubah</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="sortMode" value="new" onchange="hierarchicalSetSort('new')">
                    <span>Berdasarkan Waktu Dibuat</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="sortMode" value="az" onchange="hierarchicalSetSort('az')">
                    <span>Alfabet (A-Z)</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="sortMode" value="za" onchange="hierarchicalSetSort('za')">
                    <span>Alfabet Terbalik (Z-A)</span>
                </label>
            </div>
            <div class="flex justify-end mt-4">
                <button onclick="closeModal('modalSortMain')" class="px-4 py-2 text-sm hover:bg-gray-100 rounded">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal: Detail -->
    <div id="modalDetail" class="modal modal-hierarchical z-high">
        <div class="bg-white w-full max-w-md rounded-lg p-5">
            <h3 class="font-bold mb-4">Detail</h3>
            <div id="detailContent" class="space-y-2"></div>
            <div class="flex justify-end mt-6">
                <button onclick="closeModal('modalDetail')" class="px-4 py-2 text-sm hover:bg-gray-100 rounded">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal: Tambah Catatan Utama -->
    <div id="modalAddHeadNote" class="modal modal-hierarchical z-high">
        <div class="bg-white w-full max-w-md rounded-lg p-5">
            <h3 class="font-bold mb-4">Tambah Catatan Utama</h3>
            <textarea id="headNoteInput" class="w-full border p-2 rounded mb-4 h-32" placeholder="Isi catatan utama..."></textarea>
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal('modalAddHeadNote')" class="px-4 py-2 text-sm hover:bg-gray-100 rounded">Batal</button>
                <button onclick="hierarchicalAddHeadItem('note')" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Tambah</button>
            </div>
        </div>
    </div>

    <!-- Modal: Tambah Link Utama -->
    <div id="modalAddHeadLink" class="modal modal-hierarchical z-high">
        <div class="bg-white w-full max-w-md rounded-lg p-5">
            <h3 class="font-bold mb-4">Tambah Link Utama</h3>
            <input type="text" id="headLinkUrl" class="w-full border p-2 rounded mb-2" placeholder="URL (contoh: https://example.com)">
            <input type="text" id="headLinkTitle" class="w-full border p-2 rounded mb-4" placeholder="Judul Link (opsional)">
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal('modalAddHeadLink')" class="px-4 py-2 text-sm hover:bg-gray-100 rounded">Batal</button>
                <button onclick="hierarchicalAddHeadItem('link')" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Tambah</button>
            </div>
        </div>
    </div>

    <!-- Modal: Tambah Gambar Utama -->
    <div id="modalAddHeadImg" class="modal modal-hierarchical z-high">
        <div class="bg-white w-full max-w-md rounded-lg p-5">
            <h3 class="font-bold mb-4">Tambah Gambar Utama</h3>
            <input type="text" id="headImgUrl" class="w-full border p-2 rounded mb-2" placeholder="URL Gambar">
            <input type="file" id="headImgFile" accept="image/*" class="w-full border p-2 rounded mb-4">
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal('modalAddHeadImg')" class="px-4 py-2 text-sm hover:bg-gray-100 rounded">Batal</button>
                <button onclick="hierarchicalAddHeadItem('image')" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Tambah</button>
            </div>
        </div>
    </div>

    <!-- Modal: Edit Item Utama -->
    <div id="modalEditHead" class="modal modal-hierarchical z-high">
        <div class="bg-white w-full max-w-md rounded-lg p-5">
            <h3 id="editHeadTitle" class="font-bold mb-4">Edit Item Utama</h3>
            <div id="editNoteSection">
                <textarea id="editHeadNote" class="w-full border p-2 rounded mb-4 h-32" placeholder="Isi catatan utama..."></textarea>
            </div>
            <div id="editLinkSection" style="display:none">
                <input type="text" id="editHeadLinkUrl" class="w-full border p-2 rounded mb-2" placeholder="URL">
                <input type="text" id="editHeadLinkTitle" class="w-full border p-2 rounded mb-4" placeholder="Judul Link">
            </div>
            <div id="editImgSection" style="display:none">
                <input type="text" id="editHeadImgUrl" class="w-full border p-2 rounded mb-2" placeholder="URL Gambar">
                <input type="file" id="editHeadImgFile" accept="image/*" class="w-full border p-2 rounded mb-4">
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal('modalEditHead')" class="px-4 py-2 text-sm hover:bg-gray-100 rounded">Batal</button>
                <button onclick="hierarchicalSaveHeadEdit()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal: Embed (Sub-Item) -->
    <div id="modalAddSub" class="modal modal-hierarchical z-high">
        <div class="bg-white w-full max-w-md rounded-lg p-5">
            <h3 id="subModalTitle" class="font-bold mb-4">Tambah Item Embed</h3>
            <div id="subNoteSection">
                <textarea id="subNoteInput" class="w-full border p-2 rounded mb-4 h-32" placeholder="Isi embed note..."></textarea>
            </div>
            <div id="subLinkSection" style="display:none">
                <input type="text" id="subLinkUrl" class="w-full border p-2 rounded mb-2" placeholder="URL (contoh: https://example.com)">
                <input type="text" id="subLinkTitle" class="w-full border p-2 rounded mb-4" placeholder="Judul Link (opsional)">
            </div>
            <div id="subImgSection" style="display:none">
                <input type="text" id="subImgUrl" class="w-full border p-2 rounded mb-2" placeholder="URL Gambar Embed">
                <input type="file" id="subImgFile" accept="image/*" class="w-full border p-2 rounded mb-4">
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal('modalAddSub')" class="px-4 py-2 text-sm hover:bg-gray-100 rounded">Batal</button>
                <button onclick="hierarchicalSaveSubItem()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Simpan Embed</button>
            </div>
        </div>
    </div>

    <!-- Modal: Edit Sub-Item -->
    <div id="modalEditSub" class="modal modal-hierarchical z-high">
        <div class="bg-white w-full max-w-md rounded-lg p-5">
            <h3 id="editSubTitle" class="font-bold mb-4">Edit Sub-Item</h3>
            <div id="editSubNoteSection">
                <textarea id="editSubNote" class="w-full border p-2 rounded mb-4 h-32" placeholder="Isi catatan..."></textarea>
            </div>
            <div id="editSubLinkSection" style="display:none">
                <input type="text" id="editSubLinkUrl" class="w-full border p-2 rounded mb-2" placeholder="URL">
                <input type="text" id="editSubLinkTitle" class="w-full border p-2 rounded mb-4" placeholder="Judul Link">
            </div>
            <div id="editSubImgSection" style="display:none">
                <input type="text" id="editSubImgUrl" class="w-full border p-2 rounded mb-2" placeholder="URL Gambar">
                <input type="file" id="editSubImgFile" accept="image/*" class="w-full border p-2 rounded mb-4">
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal('modalEditSub')" class="px-4 py-2 text-sm hover:bg-gray-100 rounded">Batal</button>
                <button onclick="hierarchicalSaveSubEdit()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- ===== FULLSCREEN PANEL FOR HIERARCHICAL CONTENT ===== -->
    <div id="contentPanel" class="h-panel-fs">
        <div class="h-panel-header">
            <button class="h-btn px-4 py-2" onclick="hierarchicalClosePanel()">‚Üê Kembali</button>
            <div id="activeTitle" class="h-panel-title">Judul</div>
            <div class="relative">
                <button class="h-btn h-btn-icon" onclick="hierarchicalToggleDropdown('panelMenu', this)">‚ãÆ</button>
                <div id="panelMenu" class="h-dropdown-content">
                    <div class="h-drop-item" onclick="openModal('modalEditTitle')">‚úèÔ∏è Edit Judul</div>
                    <div class="h-drop-item" onclick="openModal('modalAddHeadNote')">‚ûï Tambah Catatan</div>
                    <div class="h-drop-item" onclick="openModal('modalAddHeadLink')">üîó Tambah Link</div>
                    <div class="h-drop-item" onclick="openModal('modalAddHeadImg')">üñºÔ∏è Tambah Gambar</div>
                    <div class="h-drop-item" onclick="hierarchicalShowDetails()">üìã Detail</div>
                    <div class="h-drop-item text-red-500" onclick="hierarchicalDeleteRoot()">üóëÔ∏è Hapus Konten</div>
                </div>
            </div>
        </div>
        <div class="h-panel-body" id="panelBody"></div>
    </div>

    <script>
        // --- DATA STATE ---
        let appState = {
            activeTabId: 'main',
            tabs: JSON.parse(localStorage.getItem('tabs')) || [{ 
                id: 'main', 
                name: 'Utama', 
                type: 'hierarchical',
                sortMode: 'updated',
                contents: [],
                selectedLoadSource: { type: 'github', id: null },
                selectedExportSource: { type: 'github', id: null }
            }],
            sources: JSON.parse(localStorage.getItem('sources')) || { 
                github: [], 
                localstorage: [] 
            }
        };

        // --- HIERARCHICAL STATE ---
        let hierarchicalActiveRootId = null;
        let hierarchicalActiveHeadId = null;
        let hierarchicalActiveSubType = 'note';
        let hierarchicalActiveTabId = null;
        let hierarchicalActiveSubIndex = null;

        // --- CORE FUNCTIONS ---
        function saveData() {
            localStorage.setItem('tabs', JSON.stringify(appState.tabs));
            localStorage.setItem('sources', JSON.stringify(appState.sources));
        }

        function toggleSettingsPanel(event) {
            const panel = document.getElementById('sources-panel');
            const isActive = panel.classList.contains('active');
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            if (!isActive) {
                panel.classList.add('active');
                // Position panel to right
                const button = event.target;
                const rect = button.getBoundingClientRect();
                panel.style.right = '10px';
                panel.style.top = rect.bottom + 'px';
                panel.style.left = 'auto';
            }
        }

        function openModal(id) {
            document.querySelectorAll('.h-dropdown-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            if (id === 'all') {
                document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            } else {
                document.getElementById(id).classList.remove('active');
            }
        }

        // --- TAB MANAGEMENT ---
        function renderTabs() {
            const nav = document.getElementById('tab-nav');
            const container = document.getElementById('tab-container');
            nav.innerHTML = '';
            
            appState.tabs.forEach(tab => {
                const btn = document.createElement('button');
                btn.className = `px-4 py-3 whitespace-nowrap text-sm font-medium border-b-2 ${appState.activeTabId === tab.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-600 hover:text-gray-800'}`;
                btn.innerText = tab.name;
                btn.onclick = () => switchTab(tab.id);
                nav.appendChild(btn);

                if(!document.getElementById(`content-${tab.id}`)) {
                    const contentDiv = document.createElement('div');
                    contentDiv.id = `content-${tab.id}`;
                    contentDiv.className = `tab-content ${appState.activeTabId === tab.id ? 'active' : ''}`;
                    container.appendChild(contentDiv);
                }
            });

            const addBtn = document.createElement('button');
            addBtn.className = "px-4 py-2 text-blue-600 font-bold text-xl hover:bg-blue-50 rounded";
            addBtn.innerText = "+";
            addBtn.onclick = () => openModal('add-tab-modal');
            nav.appendChild(addBtn);

            renderTabContents();
        }

        function switchTab(id) {
            appState.activeTabId = id;
            hierarchicalActiveTabId = id;
            
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            const contentEl = document.getElementById(`content-${id}`);
            if (contentEl) {
                contentEl.classList.add('active');
            }
            renderTabs();
        }

        function createNewTab() {
            const name = document.getElementById('new-tab-name').value;
            if (!name) return;
            const newTab = { 
                id: 'tab-' + Date.now(), 
                name: name, 
                type: 'hierarchical',
                sortMode: 'updated',
                contents: [],
                selectedLoadSource: { type: 'github', id: null },
                selectedExportSource: { type: 'github', id: null }
            };
            appState.tabs.push(newTab);
            saveData();
            closeModal('add-tab-modal');
            document.getElementById('new-tab-name').value = '';
            switchTab(newTab.id);
        }

        function renderTabContents() {
            const tab = appState.tabs.find(t => t.id === appState.activeTabId);
            if (!tab) return;
            
            const container = document.getElementById(`content-${tab.id}`);
            renderHierarchicalTab(container, tab);
        }

        function renderHierarchicalTab(container, tab) {
            if (!container || !tab) return;
            
            container.innerHTML = `
                <div class="flex items-center space-x-2 mb-4">
                    <input type="text" id="searchMain-${tab.id}" class="h-search-input" placeholder="Cari konten..." 
                           oninput="hierarchicalRenderMain('${tab.id}')" 
                           value="${tab.searchQuery || ''}">
                    <button class="h-btn h-btn-primary h-btn-icon" onclick="openModal('modalAddRoot')">+</button>
                    <div class="relative">
                        <button class="h-btn h-btn-icon" onclick="hierarchicalToggleDropdown('mainSettings-${tab.id}', this)">‚öôÔ∏è</button>
                        <div id="mainSettings-${tab.id}" class="h-dropdown-content">
                            <div class="h-drop-item" onclick="openModal('modalSortMain')">‚áÖ Urutkan</div>
                            <div class="h-drop-item" onclick="openCurrentDataForTab()">üìÇ Muat Data</div>
                            <div class="h-drop-item" onclick="openExportDataForTab()">üíæ Ekspor Data</div>
                            <div class="h-drop-item text-red-500" onclick="clearTabData('${tab.id}')">üóëÔ∏è Hapus Semua</div>
                            ${appState.tabs.length > 1 ? `<div class="h-drop-item text-red-600 font-bold" onclick="deleteTab('${tab.id}')">‚úó Hapus Tab</div>` : ''}
                        </div>
                    </div>
                </div>
                <div id="rootList-${tab.id}" class="space-y-2"></div>
            `;
            
            hierarchicalRenderMain(tab.id);
        }

        // --- HIERARCHICAL PANEL FUNCTIONS dengan auto-flip yang diperbaiki ---
        function hierarchicalToggleDropdown(id, buttonElement) {
            const el = document.getElementById(id);
            const isOpen = el.classList.contains('active');
            
            document.querySelectorAll('.h-dropdown-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            
            if(!isOpen) {
                el.classList.add('active');
                // Position dengan auto-flip yang benar
                positionDropdownWithFlip(el, buttonElement, true); // true untuk anchor ke kanan
            }
        }

        // Fungsi untuk positioning dropdown dengan auto-flip yang benar
        function positionDropdownWithFlip(dropdown, button, anchorRight = true) {
            if (!dropdown || !button) return;
            
            const buttonRect = button.getBoundingClientRect();
            const dropdownRect = dropdown.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            let left, top;
            
            if (anchorRight) {
                // Anchor ke kanan: dropdown muncul di sebelah kanan tombol
                left = buttonRect.right + 5;
                top = buttonRect.top;
                
                // Jika dropdown akan keluar dari viewport di kanan, pindah ke kiri
                if (left + dropdownRect.width > viewportWidth - 10) {
                    left = buttonRect.left - dropdownRect.width - 5;
                }
            } else {
                // Anchor ke kiri: dropdown muncul di sebelah kiri tombol
                left = buttonRect.left - dropdownRect.width - 5;
                top = buttonRect.top;
                
                // Jika dropdown akan keluar dari viewport di kiri, pindah ke kanan
                if (left < 10) {
                    left = buttonRect.right + 5;
                }
            }
            
            // Cek jika dropdown akan keluar dari viewport di atas
            if (top < 10) {
                top = 10;
            }
            
            // Cek jika dropdown akan keluar dari viewport di bawah
            if (top + dropdownRect.height > viewportHeight - 10) {
                top = viewportHeight - dropdownRect.height - 10;
            }
            
            dropdown.style.left = left + 'px';
            dropdown.style.top = top + 'px';
        }

        // --- Level 1: Root Management ---
        function hierarchicalAddRoot() {
            const title = document.getElementById('rootTitleInput').value.trim();
            if(!title) return;
            
            const tab = appState.tabs.find(t => t.id === appState.activeTabId);
            if (!tab) return;
            
            const id = "ID-" + Math.random().toString(36).substr(2, 9).toUpperCase();
            tab.contents.push({
                id: id,
                title: title,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                heads: []
            });
            saveData();
            hierarchicalRenderMain(appState.activeTabId);
            closeModal('modalAddRoot');
            document.getElementById('rootTitleInput').value = "";
        }

        function hierarchicalSaveTitle() {
            const newTitle = document.getElementById('editTitleInput').value.trim();
            if(!newTitle) return;
            
            const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
            if (!tab) return;
            
            const root = tab.contents.find(r => r.id === hierarchicalActiveRootId);
            if (!root) return;
            
            root.title = newTitle;
            root.updatedAt = new Date().toISOString();
            saveData();
            
            document.getElementById('activeTitle').innerText = newTitle;
            hierarchicalRenderMain(hierarchicalActiveTabId);
            closeModal('modalEditTitle');
            document.getElementById('editTitleInput').value = "";
        }

        function hierarchicalRenderMain(tabId) {
            const list = document.getElementById(`rootList-${tabId}`);
            if (!list) return;
            
            const tab = appState.tabs.find(t => t.id === tabId);
            if (!tab) return;
            
            const searchInput = document.getElementById(`searchMain-${tabId}`);
            const searchQuery = searchInput ? searchInput.value.toLowerCase() : '';
            tab.searchQuery = searchQuery;
            
            list.innerHTML = "";

            let filtered = tab.contents.filter(r => r.title.toLowerCase().includes(searchQuery));
            
            if(tab.sortMode === 'az') {
                filtered.sort((a,b) => a.title.localeCompare(b.title));
            } else if(tab.sortMode === 'za') {
                filtered.sort((a,b) => b.title.localeCompare(a.title));
            } else if(tab.sortMode === 'new') {
                filtered.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            } else if(tab.sortMode === 'updated') {
                filtered.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            }

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üìù</div>
                        <p>Tidak ada konten</p>
                        <p class="text-sm mt-2">Klik tombol "+" untuk menambahkan konten baru</p>
                    </div>
                `;
                return;
            }

            filtered.forEach(root => {
                const card = document.createElement('div');
                card.className = "h-card";
                card.onclick = () => hierarchicalOpenPanel(root.id, tabId);
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="h-card-id">${root.id}</div>
                            <div class="h-card-title">${root.title}</div>
                        </div>
                        <div class="flex items-center space-x-1">
                            <span class="type-badge">${root.heads.length} item</span>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function hierarchicalSetSort(mode) {
            const tab = appState.tabs.find(t => t.id === appState.activeTabId);
            if (!tab) return;
            
            tab.sortMode = mode;
            saveData();
            
            // Update radio buttons
            document.querySelectorAll('input[name="sortMode"]').forEach(radio => {
                radio.checked = radio.value === mode;
            });
            
            hierarchicalRenderMain(appState.activeTabId);
            closeModal('modalSortMain');
        }

        // --- Level 2: Panel Management ---
        function hierarchicalOpenPanel(rootId, tabId) {
            hierarchicalActiveRootId = rootId;
            hierarchicalActiveTabId = tabId || appState.activeTabId;
            
            const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
            if (!tab) return;
            
            const root = tab.contents.find(r => r.id === rootId);
            if (!root) return;
            
            document.getElementById('activeTitle').innerText = root.title;
            document.getElementById('editTitleInput').value = root.title; // Prefill edit modal
            document.getElementById('contentPanel').classList.add('active');
            hierarchicalRenderHeads();
        }

        function hierarchicalClosePanel() {
            document.getElementById('contentPanel').classList.remove('active');
            hierarchicalActiveRootId = null;
            
            if (hierarchicalActiveTabId) {
                hierarchicalRenderMain(hierarchicalActiveTabId);
            }
        }

        // --- Fungsi untuk Head Item ---
        function hierarchicalAddHeadItem(type) {
            const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
            if (!tab) return;
            
            const root = tab.contents.find(r => r.id === hierarchicalActiveRootId);
            if (!root) return;
            
            let head = { id: Date.now(), type, subs: [] };

            if(type === 'note') {
                const val = document.getElementById('headNoteInput').value.trim();
                if(!val) return;
                head.content = val;
                root.heads.push(head);
                hierarchicalFinishHead();
            } else if(type === 'link') {
                const url = document.getElementById('headLinkUrl').value.trim();
                const title = document.getElementById('headLinkTitle').value.trim();
                if(!url) return;
                head.content = { url, title };
                root.heads.push(head);
                hierarchicalFinishHead();
            } else if(type === 'image') {
                const url = document.getElementById('headImgUrl').value.trim();
                const file = document.getElementById('headImgFile').files[0];
                if(!url && !file) return;

                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        head.content = e.target.result;
                        root.heads.push(head);
                        hierarchicalFinishHead();
                    };
                    reader.readAsDataURL(file);
                } else {
                    head.content = url;
                    root.heads.push(head);
                    hierarchicalFinishHead();
                }
            }
        }

        function hierarchicalFinishHead() {
            const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
            if (!tab) return;
            
            const root = tab.contents.find(r => r.id === hierarchicalActiveRootId);
            if (!root) return;
            
            root.updatedAt = new Date().toISOString();
            saveData();
            hierarchicalRenderHeads();
            closeModal('all');
            document.getElementById('headNoteInput').value = "";
            document.getElementById('headLinkUrl').value = "";
            document.getElementById('headLinkTitle').value = "";
            document.getElementById('headImgUrl').value = "";
            document.getElementById('headImgFile').value = "";
        }

        function hierarchicalRenderHeads() {
            const body = document.getElementById('panelBody');
            const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
            if (!body || !tab) return;
            
            const root = tab.contents.find(r => r.id === hierarchicalActiveRootId);
            if (!root) return;
            
            body.innerHTML = "";

            if (root.heads.length === 0) {
                body.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üìã</div>
                        <p>Belum ada item</p>
                        <p class="text-sm mt-2">Gunakan menu "‚ãÆ" untuk menambahkan catatan, link, atau gambar</p>
                    </div>
                `;
                return;
            }

            root.heads.forEach(head => {
                const div = document.createElement('div');
                div.className = "h-head-item";
                
                let contentHTML = '';
                if(head.type === 'note') {
                    contentHTML = `<div class="h-sub-text-wrapper">${head.content}</div>`;
                } else if(head.type === 'link') {
                    const title = head.content.title || head.content.url;
                    contentHTML = `
                        <a href="${head.content.url}" target="_blank" rel="noopener noreferrer" class="h-link">
                            ${title}
                        </a>
                    `;
                } else if(head.type === 'image') {
                    contentHTML = `<img src="${head.content}" class="h-head-img" onerror="this.src='https://via.placeholder.com/400x300?text=Gambar+Tidak+Ditemukan'">`;
                }
                
                div.innerHTML = `
                    <div class="h-head-header">
                        <div class="flex items-center space-x-2">
                            <small class="type-badge">${head.type === 'note' ? 'CATATAN' : head.type === 'link' ? 'LINK' : 'GAMBAR'}</small>
                            <small class="text-xs text-gray-500">${head.subs.length} embed(s)</small>
                        </div>
                        <div class="relative">
                            <button class="h-btn px-3 py-1" onclick="event.stopPropagation(); hierarchicalToggleDropdownHead(event, ${head.id}, this)">‚ãÆ</button>
                        </div>
                    </div>
                    <div class="h-head-content">
                        ${contentHTML}
                    </div>
                    <div class="h-sub-container" id="subBox-${head.id}"></div>
                `;
                body.appendChild(div);
                hierarchicalRenderSubs(head);
            });
        }

        // FIXED: Dropdown handler untuk head items dengan positioning yang benar
        function hierarchicalToggleDropdownHead(event, headId, buttonElement) {
            event.stopPropagation();
            
            // Tutup semua dropdown lainnya
            document.querySelectorAll('.h-dropdown-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.h-sub-dropdown').forEach(d => d.remove());
            
            // Buat dropdown baru di posisi yang benar
            const dropdownId = `headDropdown-${headId}`;
            let dropdown = document.getElementById(dropdownId);
            
            if (!dropdown) {
                dropdown = document.createElement('div');
                dropdown.id = dropdownId;
                dropdown.className = "h-dropdown-content";
                dropdown.innerHTML = `
                    <div class="h-drop-item" onclick="hierarchicalEditHead(${headId})">‚úèÔ∏è Edit Item Utama</div>
                    <div class="h-drop-item" onclick="hierarchicalPrepareSub(${headId}, 'note')">üîó Embed Catatan</div>
                    <div class="h-drop-item" onclick="hierarchicalPrepareSub(${headId}, 'link')">üåê Embed Link</div>
                    <div class="h-drop-item" onclick="hierarchicalPrepareSub(${headId}, 'image')">üñºÔ∏è Embed Gambar</div>
                    <div class="h-drop-item text-red-500" onclick="hierarchicalDeleteHead(${headId})">üóëÔ∏è Hapus</div>
                `;
                document.body.appendChild(dropdown);
            }
            
            // Position dropdown dengan auto-flip yang benar untuk head items (anchor ke kanan)
            positionDropdownWithFlip(dropdown, buttonElement, false);
            
            // Toggle dropdown
            const isOpen = dropdown.classList.contains('active');
            if (!isOpen) {
                dropdown.classList.add('active');
            } else {
                dropdown.classList.remove('active');
            }
        }

        // --- Fungsi Edit Head Item ---
        function hierarchicalEditHead(headId) {
            hierarchicalActiveHeadId = headId;
            const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
            if (!tab) return;
            
            const root = tab.contents.find(r => r.id === hierarchicalActiveRootId);
            if (!root) return;
            
            const head = root.heads.find(h => h.id === headId);
            if (!head) return;
            
            // Set judul modal
            const typeMap = { note: 'Catatan', link: 'Link', image: 'Gambar' };
            document.getElementById('editHeadTitle').innerText = `Edit ${typeMap[head.type]} Utama`;
            
            // Sembunyikan semua section
            document.getElementById('editNoteSection').style.display = 'none';
            document.getElementById('editLinkSection').style.display = 'none';
            document.getElementById('editImgSection').style.display = 'none';
            
            // Tampilkan section yang sesuai dan isi dengan data lama
            if(head.type === 'note') {
                document.getElementById('editNoteSection').style.display = 'block';
                document.getElementById('editHeadNote').value = head.content;
            } else if(head.type === 'link') {
                document.getElementById('editLinkSection').style.display = 'block';
                document.getElementById('editHeadLinkUrl').value = head.content.url;
                document.getElementById('editHeadLinkTitle').value = head.content.title || '';
            } else if(head.type === 'image') {
                document.getElementById('editImgSection').style.display = 'block';
                if(head.content.startsWith('data:image')) {
                    // Jika gambar berupa data URL (upload), kosongkan field
                    document.getElementById('editHeadImgUrl').value = '';
                } else {
                    document.getElementById('editHeadImgUrl').value = head.content;
                }
            }
            
            openModal('modalEditHead');
        }

        function hierarchicalSaveHeadEdit() {
            const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
            if (!tab) return;
            
            const root = tab.contents.find(r => r.id === hierarchicalActiveRootId);
            if (!root) return;
            
            const head = root.heads.find(h => h.id === hierarchicalActiveHeadId);
            if (!head) return;
            
            if(head.type === 'note') {
                const val = document.getElementById('editHeadNote').value.trim();
                if(!val) return;
                head.content = val;
            } else if(head.type === 'link') {
                const url = document.getElementById('editHeadLinkUrl').value.trim();
                const title = document.getElementById('editHeadLinkTitle').value.trim();
                if(!url) return;
                head.content = { url, title };
            } else if(head.type === 'image') {
                const url = document.getElementById('editHeadImgUrl').value.trim();
                const file = document.getElementById('editHeadImgFile').files[0];
                
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        head.content = e.target.result;
                        finishHeadEdit();
                    };
                    reader.readAsDataURL(file);
                    return;
                } else if(url) {
                    head.content = url;
                } else {
                    // Jika tidak ada input baru, biarkan gambar lama
                }
            }
            
            finishHeadEdit();
        }

        function finishHeadEdit() {
            const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
            if (!tab) return;
            
            const root = tab.contents.find(r => r.id === hierarchicalActiveRootId);
            if (!root) return;
            
            root.updatedAt = new Date().toISOString();
            saveData();
            hierarchicalRenderHeads();
            closeModal('modalEditHead');
            
            // Reset fields
            document.getElementById('editHeadNote').value = '';
            document.getElementById('editHeadLinkUrl').value = '';
            document.getElementById('editHeadLinkTitle').value = '';
            document.getElementById('editHeadImgUrl').value = '';
            document.getElementById('editHeadImgFile').value = '';
        }

        // --- Level 3: Subs Management ---
        function hierarchicalPrepareSub(headId, type) {
            hierarchicalActiveHeadId = headId;
            hierarchicalActiveSubType = type;
            
            const typeTitles = { note: "Catatan", link: "Link", image: "Gambar" };
            document.getElementById('subModalTitle').innerText = `Tambah Embed ${typeTitles[type]}`;
            
            // Tampilkan section yang sesuai
            document.getElementById('subNoteSection').style.display = type === 'note' ? 'block' : 'none';
            document.getElementById('subLinkSection').style.display = type === 'link' ? 'block' : 'none';
            document.getElementById('subImgSection').style.display = type === 'image' ? 'block' : 'none';
            
            openModal('modalAddSub');
        }

        function hierarchicalSaveSubItem() {
            const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
            if (!tab) return;
            
            const root = tab.contents.find(r => r.id === hierarchicalActiveRootId);
            if (!root) return;
            
            const head = root.heads.find(h => h.id === hierarchicalActiveHeadId);
            if (!head) return;
            
            let sub = { id: Date.now(), type: hierarchicalActiveSubType };

            if(hierarchicalActiveSubType === 'note') {
                const val = document.getElementById('subNoteInput').value.trim();
                if(!val) return;
                sub.val = val;
                head.subs.push(sub);
                hierarchicalFinishSub();
            } else if(hierarchicalActiveSubType === 'link') {
                const url = document.getElementById('subLinkUrl').value.trim();
                const title = document.getElementById('subLinkTitle').value.trim();
                if(!url) return;
                sub.val = { url, title };
                head.subs.push(sub);
                hierarchicalFinishSub();
            } else if(hierarchicalActiveSubType === 'image') {
                const url = document.getElementById('subImgUrl').value.trim();
                const file = document.getElementById('subImgFile').files[0];
                if(!url && !file) return;

                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        sub.val = e.target.result;
                        head.subs.push(sub);
                        hierarchicalFinishSub();
                    };
                    reader.readAsDataURL(file);
                } else {
                    sub.val = url;
                    head.subs.push(sub);
                    hierarchicalFinishSub();
                }
            }
        }

        function hierarchicalFinishSub() {
            saveData();
            hierarchicalRenderHeads();
            closeModal('all');
            document.getElementById('subNoteInput').value = "";
            document.getElementById('subLinkUrl').value = "";
            document.getElementById('subLinkTitle').value = "";
            document.getElementById('subImgUrl').value = "";
            document.getElementById('subImgFile').value = "";
        }

        // --- Update Render Subs dengan ellipsis dan edit/hapus ---
        function hierarchicalRenderSubs(head) {
            const box = document.getElementById(`subBox-${head.id}`);
            if (!box) return;
            
            box.innerHTML = "";
            
            if (head.subs.length === 0) return;
            
            head.subs.forEach((sub, idx) => {
                const d = document.createElement('div');
                d.className = "h-sub-item";
                d.style.position = "relative";
                
                let contentHTML = '';
                if(sub.type === 'note') {
                    contentHTML = `<div class="h-sub-text-wrapper">${sub.val}</div>`;
                } else if(sub.type === 'link') {
                    const title = sub.val.title || sub.val.url;
                    contentHTML = `
                        <a href="${sub.val.url}" target="_blank" rel="noopener noreferrer" class="h-link">
                            ${title}
                        </a>
                    `;
                } else if(sub.type === 'image') {
                    contentHTML = `<img src="${sub.val}" class="h-sub-img">`;
                }
                
                d.innerHTML = `
                    <button class="h-sub-ellipsis" onclick="event.stopPropagation(); hierarchicalToggleSubDropdown(event, ${head.id}, ${idx}, this)">‚ãØ</button>
                    ${contentHTML}
                `;
                box.appendChild(d);
            });
        }

        // --- Dropdown untuk Sub-Item dengan Edit dan Hapus ---
        function hierarchicalToggleSubDropdown(event, headId, subIndex, buttonElement) {
            event.stopPropagation();
            
            // Tutup semua dropdown lainnya
            document.querySelectorAll('.h-dropdown-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.h-sub-dropdown').forEach(d => d.remove());
            
            // Buat dropdown baru
            const dropdownId = `subDropdown-${headId}-${subIndex}`;
            const dropdown = document.createElement('div');
            dropdown.id = dropdownId;
            dropdown.className = "h-sub-dropdown";
            dropdown.innerHTML = `
                <div class="h-drop-item" onclick="hierarchicalEditSub(${headId}, ${subIndex})">‚úèÔ∏è Edit Sub-Item</div>
                <div class="h-drop-item text-red-500" onclick="hierarchicalDeleteSub(${headId}, ${subIndex})">üóëÔ∏è Hapus</div>
            `;
            
            document.body.appendChild(dropdown);
            
            // Position dropdown dengan auto-flip yang benar untuk sub-items (anchor ke kiri karena tombol di kanan)
            positionDropdownWithFlip(dropdown, buttonElement, false); // false untuk anchor ke kiri
            
            // Toggle dropdown
            const isOpen = dropdown.classList.contains('active');
            if (!isOpen) {
                dropdown.classList.add('active');
            }
            
            // Event listener untuk menutup dropdown saat klik di luar
            const closeHandler = (e) => {
                if (!e.target.closest('.h-sub-dropdown') && !e.target.closest('.h-sub-ellipsis')) {
                    dropdown.remove();
                    document.removeEventListener('click', closeHandler);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', closeHandler);
            }, 10);
        }

        // --- Fungsi Edit Sub-Item ---
        function hierarchicalEditSub(headId, subIndex) {
            hierarchicalActiveHeadId = headId;
            hierarchicalActiveSubIndex = subIndex;
            
            const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
            if (!tab) return;
            
            const root = tab.contents.find(r => r.id === hierarchicalActiveRootId);
            if (!root) return;
            
            const head = root.heads.find(h => h.id === headId);
            if (!head) return;
            
            const sub = head.subs[subIndex];
            if (!sub) return;
            
            // Set judul modal
            const typeMap = { note: 'Catatan', link: 'Link', image: 'Gambar' };
            document.getElementById('editSubTitle').innerText = `Edit Embed ${typeMap[sub.type]}`;
            
            // Sembunyikan semua section
            document.getElementById('editSubNoteSection').style.display = 'none';
            document.getElementById('editSubLinkSection').style.display = 'none';
            document.getElementById('editSubImgSection').style.display = 'none';
            
            // Tampilkan section yang sesuai dan isi dengan data lama
            if(sub.type === 'note') {
                document.getElementById('editSubNoteSection').style.display = 'block';
                document.getElementById('editSubNote').value = sub.val;
            } else if(sub.type === 'link') {
                document.getElementById('editSubLinkSection').style.display = 'block';
                document.getElementById('editSubLinkUrl').value = sub.val.url;
                document.getElementById('editSubLinkTitle').value = sub.val.title || '';
            } else if(sub.type === 'image') {
                document.getElementById('editSubImgSection').style.display = 'block';
                if(sub.val.startsWith('data:image')) {
                    // Jika gambar berupa data URL (upload), kosongkan field
                    document.getElementById('editSubImgUrl').value = '';
                } else {
                    document.getElementById('editSubImgUrl').value = sub.val;
                }
            }
            
            openModal('modalEditSub');
        }

        function hierarchicalSaveSubEdit() {
            const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
            if (!tab) return;
            
            const root = tab.contents.find(r => r.id === hierarchicalActiveRootId);
            if (!root) return;
            
            const head = root.heads.find(h => h.id === hierarchicalActiveHeadId);
            if (!head) return;
            
            const sub = head.subs[hierarchicalActiveSubIndex];
            if (!sub) return;
            
            if(sub.type === 'note') {
                const val = document.getElementById('editSubNote').value.trim();
                if(!val) return;
                sub.val = val;
            } else if(sub.type === 'link') {
                const url = document.getElementById('editSubLinkUrl').value.trim();
                const title = document.getElementById('editSubLinkTitle').value.trim();
                if(!url) return;
                sub.val = { url, title };
            } else if(sub.type === 'image') {
                const url = document.getElementById('editSubImgUrl').value.trim();
                const file = document.getElementById('editSubImgFile').files[0];
                
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        sub.val = e.target.result;
                        finishSubEdit();
                    };
                    reader.readAsDataURL(file);
                    return;
                } else if(url) {
                    sub.val = url;
                } else {
                    // Jika tidak ada input baru, biarkan gambar lama
                }
            }
            
            finishSubEdit();
        }

        function finishSubEdit() {
            const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
            if (!tab) return;
            
            const root = tab.contents.find(r => r.id === hierarchicalActiveRootId);
            if (!root) return;
            
            root.updatedAt = new Date().toISOString();
            saveData();
            hierarchicalRenderHeads();
            closeModal('modalEditSub');
            
            // Reset fields
            document.getElementById('editSubNote').value = '';
            document.getElementById('editSubLinkUrl').value = '';
            document.getElementById('editSubLinkTitle').value = '';
            document.getElementById('editSubImgUrl').value = '';
            document.getElementById('editSubImgFile').value = '';
        }

        // --- Details & Cleanup ---
        function hierarchicalShowDetails() {
            const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
            if (!tab) return;
            
            const root = tab.contents.find(r => r.id === hierarchicalActiveRootId);
            if (!root) return;
            
            const n = root.heads.filter(h => h.type === 'note').length;
            const i = root.heads.filter(h => h.type === 'image').length;
            const l = root.heads.filter(h => h.type === 'link').length;
            const totalSubs = root.heads.reduce((sum, head) => sum + head.subs.length, 0);
            
            document.getElementById('detailContent').innerHTML = `
                <div class="h-detail-row"><span class="h-detail-label">Judul Konten:</span><span>${root.title}</span></div>
                <div class="h-detail-row"><span class="h-detail-label">ID:</span><span>${root.id}</span></div>
                <div class="h-detail-row"><span class="h-detail-label">Jumlah Catatan:</span><span>${n}</span></div>
                <div class="h-detail-row"><span class="h-detail-label">Jumlah Link:</span><span>${l}</span></div>
                <div class="h-detail-row"><span class="h-detail-label">Jumlah Gambar:</span><span>${i}</span></div>
                <div class="h-detail-row"><span class="h-detail-label">Total Embeds:</span><span>${totalSubs}</span></div>
                <div class="h-detail-row"><span class="h-detail-label">Dibuat:</span><span>${new Date(root.createdAt).toLocaleString('id-ID')}</span></div>
                <div class="h-detail-row"><span class="h-detail-label">Update Terakhir:</span><span>${new Date(root.updatedAt).toLocaleString('id-ID')}</span></div>
            `;
            openModal('modalDetail');
        }

        function hierarchicalDeleteRoot() {
            if(confirm("Hapus seluruh konten ini? Tindakan ini tidak dapat dibatalkan.")) {
                const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
                if (!tab) return;
                
                tab.contents = tab.contents.filter(r => r.id !== hierarchicalActiveRootId);
                saveData();
                hierarchicalClosePanel();
            }
        }

        function hierarchicalDeleteHead(hid) {
            if(confirm("Hapus item ini?")) {
                const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
                if (!tab) return;
                
                const root = tab.contents.find(r => r.id === hierarchicalActiveRootId);
                if (!root) return;
                
                root.heads = root.heads.filter(h => h.id !== hid);
                root.updatedAt = new Date().toISOString();
                saveData();
                hierarchicalRenderHeads();
            }
        }

        function hierarchicalDeleteSub(hid, idx) {
            if(confirm("Hapus embed ini?")) {
                const tab = appState.tabs.find(t => t.id === hierarchicalActiveTabId);
                if (!tab) return;
                
                const root = tab.contents.find(r => r.id === hierarchicalActiveRootId);
                if (!root) return;
                
                const head = root.heads.find(h => h.id === hid);
                if (!head) return;
                
                head.subs.splice(idx, 1);
                root.updatedAt = new Date().toISOString();
                saveData();
                
                // Hapus dropdown jika ada
                document.querySelectorAll('.h-sub-dropdown').forEach(d => d.remove());
                
                hierarchicalRenderHeads();
            }
        }

        // --- SOURCES MANAGEMENT ---
        function switchSourceTab(type) {
            if (type === 'github') {
                document.getElementById('source-tab-github').classList.remove('hidden');
                document.getElementById('source-tab-local').classList.add('hidden');
                document.getElementById('tab-btn-github').classList.add('border-b-2', 'border-blue-600');
                document.getElementById('tab-btn-local').classList.remove('border-b-2', 'border-blue-600');
            } else {
                document.getElementById('source-tab-github').classList.add('hidden');
                document.getElementById('source-tab-local').classList.remove('hidden');
                document.getElementById('tab-btn-github').classList.remove('border-b-2', 'border-blue-600');
                document.getElementById('tab-btn-local').classList.add('border-b-2', 'border-blue-600');
            }
            renderSourceLists();
        }

        function openAddGithubModal() {
            openModal('add-github-source-modal');
        }

        // Fungsi untuk menampilkan URL GitHub berdasarkan input
        function generateGitHubUrls(owner, repo, branch, path, file) {
    const urls = [];
    // Bersihkan semua input dari slash di awal/akhir untuk kontrol penuh
    const cOwner = owner.replace(/^\/+|\/+$/g, '');
    const cRepo = repo.replace(/^\/+|\/+$/g, '');
    const cBranch = branch.replace(/^\/+|\/+$/g, '') || 'main';
    const cPath = path.replace(/^\/+|\/+$/g, '');
    const cFile = file.replace(/^\/+|\/+$/g, '');

    // URL repo utama
    if (cOwner && cRepo) {
        urls.push(`https://github.com/${cOwner}/${cRepo}`);
    }
    
    // URL folder/path
    if (cOwner && cRepo && cPath) {
        urls.push(`https://github.com/${cOwner}/${cRepo}/tree/${cBranch}/${cPath}`);
    }
    
    // URL file (menggunakan slash di depan variabel path dan file)
    if (cOwner && cRepo && cFile) {
        const fullPath = (cPath ? `/${cPath}` : '') + `/${cFile}`;
        urls.push(`https://github.com/${cOwner}/${cRepo}/blob/${cBranch}${fullPath}`);
    }
    
    return [...new Set(urls)];
}

        function saveGithubSource() {
            const pat = document.getElementById('gh-pat').value;
            const owner = document.getElementById('gh-owner').value;
            const repo = document.getElementById('gh-repo').value;
            let branch = document.getElementById('gh-branch').value || 'main';
            const path = document.getElementById('gh-path').value;
            const file = document.getElementById('gh-file').value;
            
            if (!pat || !owner || !repo) {
                alert('PAT, Pemilik, dan Nama Repo harus diisi');
                return;
            }
            
            const source = {
                id: 'gh-' + Date.now(),
                pat: pat,
                owner: owner,
                repo: repo,
                branch: branch,
                path: path || '',
                file: file || 'db.json'
            };
            
            appState.sources.github.push(source);
            saveData();
            renderSourceLists();
            closeModal('add-github-source-modal');
            
            // Reset fields
            document.getElementById('gh-pat').value = '';
            document.getElementById('gh-owner').value = '';
            document.getElementById('gh-repo').value = '';
            document.getElementById('gh-branch').value = '';
            document.getElementById('gh-path').value = '';
            document.getElementById('gh-file').value = '';
        }

        function saveLocalSource() {
            const key = document.getElementById('ls-key').value;
            if (!key) {
                alert('Nama Kunci harus diisi');
                return;
            }
            
            appState.sources.localstorage.push({ 
                id: 'ls-' + Date.now(), 
                key: key 
            });
            saveData();
            renderSourceLists();
            closeModal('add-localstorage-source-modal');
            document.getElementById('ls-key').value = '';
        }

        function renderSourceLists() {
            const ghList = document.getElementById('github-list');
            const lsList = document.getElementById('localstorage-list');
            
            ghList.innerHTML = '';
            
            if (appState.sources.github.length === 0) {
                ghList.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <p>Tidak ada sumber GitHub</p>
                        <p class="text-sm mt-1">Klik "Tambah Sumber Baru" untuk menambahkan</p>
                    </div>
                `;
            } else {
                appState.sources.github.forEach(s => {
                    const urls = generateGitHubUrls(s.owner, s.repo, s.branch, s.path, s.file);
                    
                    const ghItem = document.createElement('div');
                    ghItem.className = "github-source-item";
                    
                    let urlHTML = '';
                    urls.forEach((url, index) => {
                        urlHTML += `
                            <div class="github-url-item">
                                <a href="${url}" target="_blank" class="text-blue-500 hover:underline text-xs" title="${url}">
                                    ${url}
                                </a>
                            </div>
                        `;
                    });
                    
                    ghItem.innerHTML = `
                        <div class="github-source-header">
                            <div class="github-source-title">${s.owner}/${s.repo}</div>
                            <button onclick="confirmDeleteSource('github', '${s.id}')" class="text-red-500 font-bold hover:text-red-700 text-lg">√ó</button>
                        </div>
                        <div class="github-source-details">
                            ${s.branch ? `<div>Branch: <strong>${s.branch}</strong></div>` : ''}
                            ${s.path ? `<div>Path: <strong>${s.path}</strong></div>` : ''}
                            ${s.file ? `<div>File: <strong>${s.file}</strong></div>` : ''}
                        </div>
                        ${urls.length > 0 ? `
                            <div class="github-source-url">
                                <div class="text-xs mb-1">URLs:</div>
                                ${urlHTML}
                            </div>
                        ` : ''}
                    `;
                    ghList.appendChild(ghItem);
                });
            }

            lsList.innerHTML = '';
            
            if (appState.sources.localstorage.length === 0) {
                lsList.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <p>Tidak ada sumber LocalStorage</p>
                        <p class="text-sm mt-1">Klik "Tambah Sumber Baru" untuk menambahkan</p>
                    </div>
                `;
            } else {
                appState.sources.localstorage.forEach(s => {
                    const lsItem = document.createElement('div');
                    lsItem.className = "localstorage-source-item";
                    lsItem.innerHTML = `
                        <div class="localstorage-source-header">
                            <div class="localstorage-source-title">LocalStorage Key</div>
                            <button onclick="confirmDeleteSource('localstorage', '${s.id}')" class="text-red-500 font-bold hover:text-red-700 text-lg">√ó</button>
                        </div>
                        <div class="localstorage-source-key">${s.key}</div>
                    `;
                    lsList.appendChild(lsItem);
                });
            }
        }

        function confirmDeleteSource(type, id) {
            if(confirm("Hapus sumber data ini?")) {
                appState.sources[type] = appState.sources[type].filter(s => s.id !== id);
                saveData();
                renderSourceLists();
            }
        }

        // --- CURRENT & EXPORT LOGIC ---
function updateSourceSelectors(prefix) {
    const type = document.getElementById(`${prefix}-source-type`).value;

    const listSelect = document.getElementById(`${prefix}-source-list`);
    const listContainer = document.getElementById(`${prefix}-list-container`);
    const deviceContainer = document.getElementById(`${prefix}-device-container`);

    // üî¥ EKSPOR ‚Üí FILE PERANGKAT (KHUSUS)
    if (prefix === 'exp' && type === 'device') {
        listContainer.classList.add('hidden');
        if (deviceContainer) deviceContainer.classList.add('hidden');
        return;
    }

    // reset state
    listSelect.innerHTML = '';
    if (deviceContainer) deviceContainer.classList.add('hidden');

    // üîµ LOAD DATA ‚Üí FILE PERANGKAT (LOGIC LAMA)
    if (type === 'device') {
        listContainer.classList.add('hidden');
        if (deviceContainer) deviceContainer.classList.remove('hidden');
        return;
    }

    listContainer.classList.remove('hidden');

    const sources = type === 'github'
        ? appState.sources.github
        : appState.sources.localstorage;

    const tab = appState.tabs.find(t => t.id === appState.activeTabId);

    let savedSelection = null;
    if (prefix === 'cur' && tab.selectedLoadSource) {
        savedSelection = tab.selectedLoadSource;
    } else if (prefix === 'exp' && tab.selectedExportSource) {
        savedSelection = tab.selectedExportSource;
    }

    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.innerText = 'Pilih sumber...';
    defaultOption.disabled = true;
    defaultOption.selected = true;
    listSelect.appendChild(defaultOption);

    sources.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;

        if (type === 'github') {
    let displayText = `${s.owner}/${s.repo}`;
    if (s.branch && s.branch !== 'main') displayText += ` (${s.branch})`;
    
    // Menampilkan path dengan slash di depan
    const cPath = s.path.replace(/^\/+|\/+$/g, '');
    const cFile = s.file.replace(/^\/+|\/+$/g, '');
    
    if (cPath) displayText += ` /${cPath}`;
    if (cFile) displayText += ` /${cFile}`;
    
    opt.innerText = displayText;

            const urls = generateGitHubUrls(
                s.owner,
                s.repo,
                s.branch,
                s.path,
                s.file
            );
            opt.title = urls.length > 0 ? urls[0] : '';
        } else {
            opt.innerText = s.key;
            opt.title = `LocalStorage Key: ${s.key}`;
        }

        if (
            savedSelection &&
            savedSelection.type === type &&
            savedSelection.id === s.id
        ) {
            opt.selected = true;
            defaultOption.selected = false;
        }

        listSelect.appendChild(opt);
    });
}

function triggerAddFromSelector(prefix) {
    const type = document.getElementById(`${prefix}-source-type`).value;
    if (type === 'github') openModal('add-github-source-modal');
    else if (type === 'localstorage') openModal('add-localstorage-source-modal');
}

function openCurrentDataForTab() {
    updateSourceSelectors('cur');
    openModal('current-data-modal');
}

function openExportDataForTab() {
    updateSourceSelectors('exp');
    openModal('export-data-modal');
}

        // --- FETCH & SAVE ENGINE ---
        async function loadDataFromSource() {
            const type = document.getElementById('cur-source-type').value;
            const sourceId = document.getElementById('cur-source-list').value;
            
            if (!sourceId) {
                alert('Silakan pilih sumber data');
                return;
            }
            
            const tab = appState.tabs.find(t => t.id === appState.activeTabId);
            
            // Save selection for this tab
            tab.selectedLoadSource = {
                type: type,
                id: sourceId
            };
            saveData();
            
            let loadedData = [];

            try {
if (type === 'github') {
    const s = appState.sources.github.find(x => x.id === sourceId);
    
    // Sanitasi input
    const cOwner = s.owner.replace(/^\/+|\/+$/g, '');
    const cRepo = s.repo.replace(/^\/+|\/+$/g, '');
    const cPath = s.path.replace(/^\/+|\/+$/g, '');
    const cFile = s.file.replace(/^\/+|\/+$/g, '');
    
    // Konstruksi URL: Slash diletakkan di depan variabel path (jika ada) dan file
    const pathPart = cPath ? `/${cPath}` : '';
    const filePart = `/${cFile}`;
    const apiUrl = `https://api.github.com/repos/${cOwner}/${cRepo}/contents${pathPart}${filePart}`;
    
    const resp = await fetch(apiUrl, {
                        headers: { 
                            Authorization: `token ${s.pat}`,
                            Accept: 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!resp.ok) {
                        throw new Error(`GitHub API Error: ${resp.status} ${resp.statusText}`);
                    }
                    
                    const json = await resp.json();
                    loadedData = JSON.parse(atob(json.content));
                } else if (type === 'localstorage') {
                    const s = appState.sources.localstorage.find(x => x.id === sourceId);
                    loadedData = JSON.parse(localStorage.getItem(s.key)) || [];
                }

                tab.contents = Array.isArray(loadedData) ? loadedData : [];
                saveData();
                hierarchicalRenderMain(appState.activeTabId);
                alert("Data berhasil dimuat!");
                closeModal('current-data-modal');
            } catch (e) {
                alert("Gagal memuat data: " + e.message);
                console.error(e);
            }
        }

        async function exportDataToSource() {
    const type = document.getElementById('exp-source-type').value;
    const tab = appState.tabs.find(t => t.id === appState.activeTabId);
    if (!tab) return;

    const contentString = JSON.stringify(tab.contents, null, 2);

    try {
        // üî¥ EKSPOR ‚Üí FILE PERANGKAT (HARUS DI AWAL)
        if (type === 'device') {
            const blob = new Blob([contentString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${tab.name.replace(/\s+/g, '-')}-export-${new Date()
                .toISOString()
                .slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert("Ekspor Berhasil!");
            closeModal('export-data-modal');
            return;
        }

        // ‚¨áÔ∏è BARU AMBIL sourceId SETELAH DEVICE DI-BYPASS
        const sourceId = document.getElementById('exp-source-list').value;
        if (!sourceId) {
            alert('Silakan pilih tujuan ekspor');
            return;
        }

        // Save selection for this tab
        tab.selectedExportSource = {
            type: type,
            id: sourceId
        };
        saveData();

        // ..
if (type === 'github') {
    const s = appState.sources.github.find(x => x.id === sourceId);
    
    // Sanitasi input
    const cOwner = s.owner.replace(/^\/+|\/+$/g, '');
    const cRepo = s.repo.replace(/^\/+|\/+$/g, '');
    const cPath = s.path.replace(/^\/+|\/+$/g, '');
    const cFile = s.file.replace(/^\/+|\/+$/g, '');

    // Konstruksi URL: Slash diletakkan di depan variabel
    const pathPart = cPath ? `/${cPath}` : '';
    const filePart = `/${cFile}`;
    const url = `https://api.github.com/repos/${cOwner}/${cRepo}/contents${pathPart}${filePart}`;

    let sha = "";
            try {
                const getFile = await fetch(url, {
                    headers: {
                        Authorization: `token ${s.pat}`,
                        Accept: 'application/vnd.github.v3+json'
                    }
                });
                if (getFile.ok) {
                    const fileJson = await getFile.json();
                    sha = fileJson.sha;
                }
            } catch (_) {}

            const res = await fetch(url, {
                method: 'PUT',
                headers: {
                    Authorization: `token ${s.pat}`,
                    'Content-Type': 'application/json',
                    Accept: 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    message: `Update data via Universal Data Manager - ${new Date().toISOString()}`,
                    content: btoa(unescape(encodeURIComponent(contentString))),
                    sha: sha || undefined,
                    branch: s.branch
                })
            });

            if (!res.ok) {
                const error = await res.json();
                throw new Error(`GitHub Error: ${error.message || res.statusText}`);
            }

        } else if (type === 'localstorage') {
            const s = appState.sources.localstorage.find(x => x.id === sourceId);
            localStorage.setItem(s.key, contentString);
        }

        alert("Ekspor Berhasil!");
        closeModal('export-data-modal');

    } catch (e) {
        alert("Gagal ekspor: " + e.message);
        console.error(e);
    }
}

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const tab = appState.tabs.find(t => t.id === appState.activeTabId);
                    tab.contents = Array.isArray(data) ? data : [];
                    saveData();
                    hierarchicalRenderMain(appState.activeTabId);
                    alert("File berhasil dimuat!");
                    closeModal('current-data-modal');
                } catch (err) {
                    alert("Format JSON tidak valid");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        // --- TAB SETTINGS FUNCTIONS ---
        function clearTabData(tabId) {
            if(confirm("Hapus semua konten di tab ini? Tindakan ini tidak dapat dibatalkan.")) {
                const tab = appState.tabs.find(t => t.id === tabId);
                if (!tab) return;
                
                tab.contents = [];
                saveData();
                hierarchicalRenderMain(tabId);
                closeModal('all');
            }
        }

        function deleteTab(tabId) {
            if (appState.tabs.length <= 1) {
                alert("Minimal harus ada satu tab");
                return;
            }
            
            if(confirm("Hapus tab ini secara permanen?")) {
                appState.tabs = appState.tabs.filter(t => t.id !== tabId);
                appState.activeTabId = appState.tabs[0].id;
                saveData();
                renderTabs();
                closeModal('all');
            }
        }

        // Event listener untuk menutup dropdown saat klik di luar
        window.onclick = (e) => {
            // Tutup dropdown jika klik di luar
            if (!e.target.closest('.h-dropdown-content') && !e.target.closest('.h-btn') && !e.target.closest('.h-btn-icon')) {
                document.querySelectorAll('.h-dropdown-content').forEach(d => d.classList.remove('active'));
            }
            
            // Tutup panel jika klik di luar
            if (!e.target.closest('.panel') && !e.target.closest('button[onclick*="toggleSettingsPanel"]')) {
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            }
            
            // Tutup sub-dropdown jika klik di luar
            if (!e.target.closest('.h-sub-dropdown') && !e.target.closest('.h-sub-ellipsis')) {
                document.querySelectorAll('.h-sub-dropdown').forEach(d => d.remove());
            }
        }

        // Initialize the app
        renderTabs();
        renderSourceLists();
        hierarchicalActiveTabId = appState.activeTabId;
        
        // Set default sort mode radio button
        const tab = appState.tabs.find(t => t.id === appState.activeTabId);
        if (tab) {
            setTimeout(() => {
                const radio = document.querySelector(`input[name="sortMode"][value="${tab.sortMode}"]`);
                if (radio) radio.checked = true;
            }, 100);
        }
    </script>
</body>
</html>